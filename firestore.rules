
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAppAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }

    match /users/{userId} {
      // Anyone can create a user document (signup)
      allow create: if true;
      // Only the user themselves or an admin can read it
      allow read: if isSelf(userId) || isAppAdmin();
      // A user can update their own document, but CANNOT update their roles, wallet, or membership.
      allow update: if isSelf(userId) && !("roles" in request.resource.data)
                                      && !("wallet" in request.resource.data)
                                      && !("clubMembership" in request.resource.data);
    }

    match /{collection}/{id} {
      allow read: if true;
      allow write: if isAppAdmin(); // Default to admin-only writes
    }

    match /communities/{id} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isAppAdmin() || request.auth.uid in resource.data.roles.owners;
        allow delete: if isAppAdmin() || request.auth.uid in resource.data.roles.owners;
    }

    match /events/{id} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isAppAdmin() || request.auth.uid in resource.data.organizers;
        allow delete: if isAppAdmin() || request.auth.uid in resource.data.organizers;
    }

    match /businesses/{id} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isAppAdmin() || request.auth.uid == resource.data.ownerId;
        allow delete: if isAppAdmin() || request.auth.uid == resource.data.ownerId;
    }

     match /deals/{id} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isAppAdmin() || request.auth.uid == resource.data.createdBy;
        allow delete: if isAppAdmin() || request.auth.uid == resource.data.createdBy;
    }
    
    match /saves/{saveId} {
      allow read, create, delete: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

     match /reports/{reportId} {
      allow create: if isSignedIn();
      allow read, update: if isAppAdmin();
    }

    match /bookings/{bookingId} {
        allow read: if isAppAdmin() || isSelf(resource.data.userId);
        allow create: if isSignedIn() && isSelf(request.resource.data.userId);
    }
     match /bookings/{bookingId}/tickets/{ticketId} {
        allow read, write: if isAppAdmin();
    }

    match /contact-messages/{messageId} {
        allow create: if true;
        allow read, update, delete: if isAppAdmin();
    }
  }
}
